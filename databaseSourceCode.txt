
-- =====================================================
-- CORE TABLES
-- =====================================================

-- LOCATION Table
CREATE TABLE location (
    location_id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    latitude DECIMAL(10, 8) NOT NULL,
    longitude DECIMAL(11, 8) NOT NULL,
    bounding_box GEOMETRY(POLYGON, 4326), -- Using PostGIS for spatial data
    coordinates VARCHAR(255), -- Alternative: store as text if PostGIS not available
    description TEXT,
    region VARCHAR(255),
    created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT unique_location UNIQUE (name, latitude, longitude)
);

-- Create spatial index on coordinates
CREATE INDEX idx_location_coordinates ON location USING GIST(bounding_box);

COMMENT ON TABLE location IS 'Canonical place records for mass movement risk assessment';
COMMENT ON COLUMN location.bounding_box IS 'Spatial boundary of the location (PostGIS geometry)';

-- =====================================================
-- EVENT Table (Hazard Observations)
-- =====================================================

CREATE TABLE event (
    event_id SERIAL PRIMARY KEY,
    location_id INTEGER NOT NULL REFERENCES location(location_id) ON DELETE CASCADE,
    date_observed TIMESTAMP NOT NULL,
    event_score DECIMAL(5, 3) CHECK (event_score >= 0 AND event_score <= 1),
    
    -- Hazard characteristics
    hazard_type VARCHAR(100) NOT NULL, -- landslide, rockfall, debris_flow, lava_flow
    hazard_type_score DECIMAL(5, 3) CHECK (hazard_type_score >= 0 AND hazard_type_score <= 1),
    
    -- Topographic factors
    slope_angle DECIMAL(5, 2), -- degrees
    curvature_number DECIMAL(10, 6),
    curvature_type VARCHAR(50), -- concave, convex, planar
    
    -- Geological factors
    lithology_type VARCHAR(100),
    lithology_level VARCHAR(50),
    lithology_soil_thickness DECIMAL(8, 2), -- in meters
    
    -- Environmental factors
    land_cover_type VARCHAR(100),
    
    created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_event_location ON event(location_id);
CREATE INDEX idx_event_date ON event(date_observed);
CREATE INDEX idx_event_hazard_type ON event(hazard_type);

COMMENT ON TABLE event IS 'Hazard observations tied to specific locations';
COMMENT ON COLUMN event.event_score IS 'Normalized event driver score H [0,1]';

-- =====================================================
-- DYNAMIC_TRIGGER Table
-- =====================================================

CREATE TABLE dynamic_trigger (
    dynamic_trigger_id SERIAL PRIMARY KEY,
    event_id INTEGER NOT NULL REFERENCES event(event_id) ON DELETE CASCADE,
    trigger_type VARCHAR(100) NOT NULL,
    
    -- Rainfall triggers
    rainfall_duration_hrs DECIMAL(8, 2),
    rainfall_intensity_mm_hr DECIMAL(8, 2),
    is_rainfall_exceeded BOOLEAN,
    
    -- Other triggers
    earthquake_magnitude DECIMAL(4, 2),
    snowmelt_rate DECIMAL(8, 2),
    reservoir_drawdown_rate DECIMAL(8, 2),
    wildfire_burn_severity_size DECIMAL(10, 2),
    
    created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_dynamic_trigger_event ON dynamic_trigger(event_id);
CREATE INDEX idx_dynamic_trigger_type ON dynamic_trigger(trigger_type);

COMMENT ON TABLE dynamic_trigger IS 'Dynamic triggers that initiate hazard events';

-- =====================================================
-- VULNERABILITY Table
-- =====================================================

CREATE TABLE vulnerability (
    vulnerability_id SERIAL PRIMARY KEY,
    location_id INTEGER NOT NULL REFERENCES location(location_id) ON DELETE CASCADE,
    vulnerability_score DECIMAL(5, 3) CHECK (vulnerability_score >= 0 AND vulnerability_score <= 1),
    
    -- Exposure factors
    asset_type VARCHAR(100),
    population_density DECIMAL(10, 2),
    time_of_day VARCHAR(50),
    
    -- Infrastructure counts
    num_roads INTEGER DEFAULT 0,
    num_buildings INTEGER DEFAULT 0,
    num_pipelines INTEGER DEFAULT 0,
    num_power_lines INTEGER DEFAULT 0,
    
    -- Criticality factors
    num_hospitals INTEGER DEFAULT 0,
    num_schools INTEGER DEFAULT 0,
    num_evacuation_routes INTEGER DEFAULT 0,
    
    -- Building characteristics
    building_type VARCHAR(100),
    building_material VARCHAR(100),
    num_building_floor INTEGER,
    
    -- Environmental context
    area_type VARCHAR(100), -- urban, rural, mixed
    land_cover_type VARCHAR(100),
    
    created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_vulnerability_location ON vulnerability(location_id);
CREATE INDEX idx_vulnerability_asset_type ON vulnerability(asset_type);

COMMENT ON TABLE vulnerability IS 'Ontologicity (entity traits) at specific locations';
COMMENT ON COLUMN vulnerability.vulnerability_score IS 'Normalized vulnerability score V [0,1]';


CREATE TABLE local_lore (
    lore_id SERIAL PRIMARY KEY,
    location_id INTEGER NOT NULL REFERENCES location(location_id) ON DELETE CASCADE,
    
    -- Core narrative and location
    lore_narrative TEXT NOT NULL,
    place_name VARCHAR(255), -- Specific place mentioned in the narrative
    event_location_name VARCHAR(255), -- Name of the location where event occurred
    
    -- Source information (formerly SOURCE table)
    source_type VARCHAR(100) NOT NULL, -- oral_tradition, newspaper, instrumented, field_notes, eyewitness, historical, indigenous
    source_title VARCHAR(500),
    source_url TEXT,
    lore_title TEXT,
    source_author VARCHAR(255),
    geotagged_photos TEXT, -- JSON array or comma-separated URLs
    
    -- Temporal factors (for L1: Recency score)
    event_date DATE,
    event_date_uncertainty_year INTEGER DEFAULT 0,
    years_ago INTEGER, -- Computed: current year - event year
    
    -- Spatial factors (for L3: Spatial relevance score)
    distance_to_report_location DECIMAL(10, 2), -- Distance from event location to current assessment site (in meters)
    
    -- Confidence metrics
    confidence_band VARCHAR(50), -- high, medium, low
    spatial_confidence DECIMAL(5, 3) CHECK (spatial_confidence >= 0 AND spatial_confidence <= 1),
    temporal_confidence DECIMAL(5, 3) CHECK (temporal_confidence >= 0 AND temporal_confidence <= 1),
    credibility_confidence DECIMAL(5, 3) CHECK (credibility_confidence >= 0 AND credibility_confidence <= 1),
    
    -- Component scores for L calculation
    l1_recency_score DECIMAL(5, 3) CHECK (l1_recency_score >= 0 AND l1_recency_score <= 1), -- Based on event_date and years_ago
    l2_credibility_score DECIMAL(5, 3) CHECK (l2_credibility_score >= 0 AND l2_credibility_score <= 1), -- Based on source_type, source_title, source_url
    l3_spatial_score DECIMAL(5, 3) CHECK (l3_spatial_score >= 0 AND l3_spatial_score <= 1), -- Based on distance_to_report_location
    
    -- Overall L-score: L = 0.35*L1 + 0.40*L2 + 0.25*L3
    l_score DECIMAL(5, 3) CHECK (l_score >= 0 AND l_score <= 1),
    
    created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Create indexes
CREATE INDEX idx_local_lore_location ON local_lore(location_id);
CREATE INDEX idx_local_lore_l_score ON local_lore(l_score);
CREATE INDEX idx_local_lore_source_type ON local_lore(source_type);
CREATE INDEX idx_local_lore_event_date ON local_lore(event_date);
CREATE INDEX idx_local_lore_confidence ON local_lore(confidence_band);


-- =====================================================
-- RISK Table (Borromean Risk Assessment)
-- =====================================================

CREATE TABLE risk (
    risk_id SERIAL PRIMARY KEY,
    location_id INTEGER NOT NULL REFERENCES location(location_id) ON DELETE CASCADE,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    
    -- Borromean ring scores
    h_score DECIMAL(5, 3) CHECK (h_score >= 0 AND h_score <= 1), -- Event Driver (Hazard)
    l_score DECIMAL(5, 3) CHECK (l_score >= 0 AND l_score <= 1), -- Local Lore
    v_score DECIMAL(5, 3) CHECK (v_score >= 0 AND v_score <= 1), -- Vulnerability (Ontologicity)
    
    -- Overall risk score (computed)
    overall_score DECIMAL(5, 3) CHECK (overall_score >= 0 AND overall_score <= 1),
    
    -- Derived from probability and impact
    probability DECIMAL(5, 3),
    impact DECIMAL(5, 3),
    
    created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_risk_location ON risk(location_id);
CREATE INDEX idx_risk_overall_score ON risk(overall_score);
CREATE INDEX idx_risk_created_date ON risk(created_date);

COMMENT ON TABLE risk IS 'Borromean risk assessments combining H, L, and V factors';
COMMENT ON COLUMN risk.h_score IS 'Event Driver score (Hazard) [0,1]';
COMMENT ON COLUMN risk.l_score IS 'Local Lore & History score [0,1]';
COMMENT ON COLUMN risk.v_score IS 'Vulnerability (Ontologicity) score [0,1]';
COMMENT ON COLUMN risk.overall_score IS 'Combined Borromean risk score = f(H,L,V)';

<<<<<<< HEAD
ALTER TABLE risk
ADD COLUMN lore_id INTEGER REFERENCES local_lore(lore_id) ON DELETE SET NULL;
=======
-- =====================================================
-- DATA_SOURCES Table
-- =====================================================
-- This table tracks data sources for H, L, and V factors
-- Supports both file uploads and API connections

CREATE TABLE data_sources (
    source_id SERIAL PRIMARY KEY,
    item_id VARCHAR(255) NOT NULL UNIQUE,
    source_name VARCHAR(500) NOT NULL,
    description TEXT,
    source_type VARCHAR(100) NOT NULL, -- 'file' or 'api'
    factor_category VARCHAR(1) NOT NULL CHECK (factor_category IN ('H', 'L', 'V')),
    status VARCHAR(50) NOT NULL DEFAULT 'missing' CHECK (status IN ('missing', 'uploaded', 'connected')),

    -- File-based source fields
    file_format VARCHAR(100), -- e.g., 'GeoJSON', 'Shapefile', 'CSV', 'GeoTIFF'
    file_type VARCHAR(100), -- e.g., 'vector', 'raster'
    file_path TEXT,

    -- API-based source fields
    api_endpoint TEXT,
    api_service VARCHAR(255), -- e.g., 'USGS', 'OpenTopography', 'Custom'

    -- Version tracking
    current_version INTEGER DEFAULT 1,

    -- Metadata
    last_updated TIMESTAMP,
    uploaded_by VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Create indexes for common queries
CREATE INDEX idx_data_sources_item_id ON data_sources(item_id);
CREATE INDEX idx_data_sources_factor_category ON data_sources(factor_category);
CREATE INDEX idx_data_sources_status ON data_sources(status);
CREATE INDEX idx_data_sources_source_type ON data_sources(source_type);

COMMENT ON TABLE data_sources IS 'Tracks data sources for H (Hazard), L (Local Lore), and V (Vulnerability) factors';
COMMENT ON COLUMN data_sources.item_id IS 'Unique identifier for the data source (e.g., h-factor-dem)';
COMMENT ON COLUMN data_sources.factor_category IS 'Factor category: H (Hazard/Event), L (Local Lore), V (Vulnerability)';
COMMENT ON COLUMN data_sources.status IS 'Current status of the data source';
>>>>>>> e9220d0ea741266a57b36127e0947342fbcfc0ae
